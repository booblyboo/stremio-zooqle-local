{"version":3,"sources":["../src/ZooqleClient.js"],"names":["BASE_URL","CACHE_PREFIX","MAX_CONCURRENT_REQUESTS","CACHE_TTLS","getItemUrl","getMovieTorrents","getShowTorrents","NO_RESULTS","ZooqleClient","constructor","userName","password","userAgent","cache","proxy","Error","_userName","_password","_userAgent","_scheduler","Bottleneck","maxConcurrent","_cache","cacheManager","caching","store","_proxy","_extractTorrentsFromPage","body","$","cheerio","load","currentCategory","toArray","reduce","results","row","i","$cells","find","length","newCategory","eq","prev","text","trim","magnetLink","attr","$audioSpans","audio","undefined","languages","toUpperCase","split","$category","parent","category","users","last","seedersMatch","match","seeders","Number","replace","push","_getShowIdFromPage","_getAuthStatusFromResponse","res","Boolean","includes","_request","url","method","headers","data","schedule","options","cookies","_cookies","statusCode","_authenticate","action","remember","user","zqt","_getItemUrl","imdbId","searchUrl","location","_getMovieTorrents","_getShowTorrents","season","episode","itemUrl","itemRes","showId","torrentsUrl","torrentsRes","cacheKey","cacheOptions","ttl","bind","wrap"],"mappings":"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","sourcesContent":["import needle from 'needle'\nimport cheerio from 'cheerio'\nimport cacheManager from 'cache-manager'\nimport Bottleneck from 'bottleneck'\n\nconst BASE_URL = 'https://zooqle.com'\nconst CACHE_PREFIX = 'stremio_zooqle|'\nconst MAX_CONCURRENT_REQUESTS = 6\nconst CACHE_TTLS = {\n  // Item URLs aren't supposed to change, so we cache them for long\n  getItemUrl: 7 * 24 * 60 * 60, // a week\n  getMovieTorrents: 4 * 60 * 60, // 4 hours\n  getShowTorrents: 4 * 60 * 60, // 4 hours\n  NO_RESULTS: 10 * 60, // 10 minutes\n}\n\nclass ZooqleClient {\n  constructor({ userName, password, userAgent, cache, proxy } = {}) {\n    if (!userName || !password) {\n      throw new Error('Username and password are required')\n    }\n\n    this._userName = userName\n    this._password = password\n    this._userAgent = userAgent\n    this._scheduler = new Bottleneck({ maxConcurrent: MAX_CONCURRENT_REQUESTS })\n\n    if (cache === '1') {\n      this._cache = cacheManager.caching({ store: 'memory' })\n    }\n\n    if (proxy) {\n      this._proxy = proxy\n    }\n\n  }\n\n  _extractTorrentsFromPage(body) {\n    let $ = cheerio.load(body)\n    let currentCategory = 'Std'\n\n    return $('.table-torrents tr').toArray().reduce((results, row, i) => {\n      let $cells = $(row).find('td')\n\n      if (i === 0 || $cells.length === 1) {\n        // Sometimes a category is specified as a header on a separate row...\n        let newCategory = $cells.eq(0).find('a ~ span').prev().text().trim()\n        currentCategory = newCategory || currentCategory\n      } else {\n        let magnetLink = $cells.find('a[href^=\"magnet\"]').attr('href')\n\n        let $audioSpans = $cells.eq(1).find('div > span:not(.smallest)')\n        let audio = $audioSpans.eq(0).text() || undefined\n        let languages = $audioSpans.eq(1).text().toUpperCase()\n        languages = languages ? languages.split(',') : []\n\n        // ...and sometimes as a small icon along the audio specs\n        let $category = $cells.eq(1).find('.zqf-mi-width, .zqf-mi-3d').parent()\n        let category = $category.text().trim() || currentCategory\n\n        let users = $cells.find('.progress').last().attr('title')\n        let seedersMatch = users && users.match(/seeders:\\s*([0-9,]+)/i)\n        let seeders = seedersMatch && Number(seedersMatch[1].replace(',', ''))\n\n        results.push({ category, magnetLink, seeders, audio, languages })\n      }\n\n      return results\n    }, [])\n  }\n\n  _getShowIdFromPage(body) {\n    let match = body.match(/data-href=\"[^\"]+show=(\\d+)/)\n    return match && match[1]\n  }\n\n  _getAuthStatusFromResponse(res) {\n    return Boolean(res.body) && res.body.includes('href=\"/user/tv\"')\n  }\n\n  async _request(url, method = 'get', headers = {}, data = null) {\n    return this._scheduler.schedule(async () => {\n      let options = {\n        headers: {\n          'user-agent': this._userAgent,\n          ...headers,\n        },\n        cookies: this._cookies,\n        proxy: this._proxy,\n      }\n\n      let res = await needle(method, url, data, options)\n\n      if (res.statusCode > 399) {\n        throw new Error(`Error ${res.statusCode} when requesting ${url}`)\n      }\n\n      if (res.cookies) {\n        this._cookies = { ...this.cookies, ...res.cookies }\n      }\n\n      return res\n    })\n  }\n\n  async _authenticate() {\n    let url = `${BASE_URL}/user/register?ajax=1`\n    let data = {\n      action: 'login',\n      remember: 1,\n      user: this._userName,\n      password: this._password,\n    }\n    let headers = {\n      'content-type': 'application/x-www-form-urlencoded; charset=UTF-8',\n      'x-requested-with': 'XMLHttpRequest',\n    }\n\n    let res = await this._request(url, 'post', headers, data)\n\n    if (!res.cookies || !res.cookies.zqt) {\n      throw new Error('Unable to authenticate')\n    }\n  }\n\n  async _getItemUrl(imdbId) {\n    let searchUrl = `${BASE_URL}/search?q=${imdbId}`\n\n    let res = await this._request(searchUrl)\n\n    if (res.statusCode < 300) {\n      return\n    }\n\n    return `${BASE_URL}${res.headers.location}`\n  }\n\n  async _getMovieTorrents(imdbId) {\n    if (!this._cookies) {\n      await this._authenticate()\n    }\n\n    let url = await this.getItemUrl(imdbId)\n\n    if (!url) {\n      return []\n    }\n\n    let res = await this._request(url)\n\n    // In case the session has been terminated for whatever reason\n    // (like cookie expiration)\n    if (!this._getAuthStatusFromResponse(res)) {\n      await this._authenticate()\n      res = await this._request(url)\n    }\n\n    return this._extractTorrentsFromPage(res.body) || []\n  }\n\n  async _getShowTorrents(imdbId, season, episode) {\n    let itemUrl = await this.getItemUrl(imdbId)\n\n    if (!itemUrl) {\n      return []\n    }\n\n    let itemRes = await this._request(itemUrl)\n    let showId = this._getShowIdFromPage(itemRes.body)\n\n    if (!showId) {\n      return []\n    }\n\n    let torrentsUrl = `${BASE_URL}/misc/tveps.php` +\n      `?show=${showId}&se=${season}&ep=${episode}`\n    let torrentsRes = await this._request(torrentsUrl)\n\n    return this._extractTorrentsFromPage(torrentsRes.body) || []\n  }\n\n  async getItemUrl(imdbId) {\n    if (!this._cache) {\n      return this._getItemUrl(imdbId)\n    }\n\n    let cacheKey = `${CACHE_PREFIX}itemUrl:${imdbId}`\n    let cacheOptions = {\n      ttl: CACHE_TTLS.getItemUrl,\n    }\n    let method = this._getItemUrl.bind(this, imdbId)\n    return this._cache.wrap(cacheKey, method, cacheOptions)\n  }\n\n  async getMovieTorrents(imdbId) {\n    if (!this._cache) {\n      return this._getMovieTorrents(imdbId)\n    }\n\n    let cacheKey = `${CACHE_PREFIX}movie:${imdbId}`\n    let cacheOptions = {\n      ttl: (res) => {\n        return res.length ? CACHE_TTLS.getMovieTorrents : CACHE_TTLS.NO_RESULTS\n      },\n    }\n    let method = this._getMovieTorrents.bind(this, imdbId)\n    return this._cache.wrap(cacheKey, method, cacheOptions)\n  }\n\n  async getShowTorrents(imdbId, season, episode) {\n    if (!this._cache) {\n      return this._getShowTorrents(imdbId, season, episode)\n    }\n\n    let cacheKey = `${CACHE_PREFIX}show:${imdbId}:${season}:${episode}`\n    let cacheOptions = {\n      ttl: (res) => {\n        return res.length ? CACHE_TTLS.getShowTorrents : CACHE_TTLS.NO_RESULTS\n      },\n    }\n    let method = this._getShowTorrents.bind(this, imdbId, season, episode)\n    return this._cache.wrap(cacheKey, method, cacheOptions)\n  }\n}\n\n\nexport default ZooqleClient\n"],"file":"ZooqleClient.js"}
